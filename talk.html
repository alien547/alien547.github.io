<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>æç®€æ¶ˆæ¯å¢™</title>
</head>
<body>
  <h1>ğŸ’¬ æç®€æ¶ˆæ¯å¢™ï¼ˆä¸ä¿å­˜ï¼Œä»…å†…å­˜ï¼‰</h1>
  <div>
    <input id="username" placeholder="æ˜µç§°" value="åŒ¿å" />
    <input id="message" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." />
    <button id="send">å‘é€</button>
  </div>
  <div id="messages" style="border:1px solid #ccc; height:300px; overflow:auto; padding:10px; margin-top:10px;"></div>

  <script>
    // æ›¿æ¢æˆä½ çš„ Worker åœ°å€
    const WORKER_URL = 'https://github-api.18965565726.workers.dev/';

    // æ˜¾ç¤ºä¸€æ¡æ¶ˆæ¯
    function displayMessage(msg) {
      const div = document.createElement('div');
      div.style.margin = '5px 0';
      div.innerHTML = `<strong>${msg.user || 'åŒ¿å'}</strong> ${new Date(msg.timestamp).toLocaleTimeString()}<br>${msg.text}`;
      document.getElementById('messages').appendChild(div);
    }

    // è½®è¯¢è·å–æ‰€æœ‰æ¶ˆæ¯
    async function pollMessages() {
      try {
        const res = await fetch(`${WORKER_URL}/messages`);
        const messages = await res.json();
        const container = document.getElementById('messages');
        container.innerHTML = ''; // ç®€å•ç²—æš´ï¼Œç›´æ¥æ¸…ç©ºé‡ç»˜
        messages.forEach(displayMessage);
      } catch (e) {
        console.error('æ‹‰å–å¤±è´¥', e);
      }
    }

    // å‘é€æ¶ˆæ¯
    async function sendMessage() {
      const user = document.getElementById('username').value.trim() || 'åŒ¿å';
      const text = document.getElementById('message').value.trim();
      if (!text) return;
      await fetch(`${WORKER_URL}/send`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user, text }),
      });
      document.getElementById('message').value = '';
      // å‘é€åç«‹å³æ‹‰å–ä¸€æ¬¡ï¼ˆä¸ç”¨ç­‰è½®è¯¢ï¼‰
      pollMessages();
    }

    // æ¯2ç§’è½®è¯¢ä¸€æ¬¡
    setInterval(pollMessages, 2000);

    // ç»‘å®šäº‹ä»¶
    window.onload = () => {
      pollMessages();
      document.getElementById('send').onclick = sendMessage;
      document.getElementById('message').onkeypress = (e) => {
        if (e.key === 'Enter') sendMessage();
      };
    };
  </script>
</body>
</html>